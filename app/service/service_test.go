package service

import (
	"context"
	"encoding/json"
	"testing"

	"github.com/cryptoless/chain-raw-api-server/callserver"
	"github.com/cryptoless/chain-raw-api-server/message"
	"github.com/gogf/gf/test/gtest"
)

var calljs = `{
	"context": {
	  "difficulty": "3699098917",
	  "gasLimit": "5258985",
	  "miner": "0xd049bfd667cb46aa3ef5df0da3e57db3be39e511",
	  "number": "2294631",
	  "timestamp": "1513675366"
	},
	"genesis": {
	  "alloc": {

		"0xC20581085D9a543a81Fa9A70Dc5c8A78f6e29A3f": {
			"balance": "0xea8c39a876d19888d",
			"code": "0x",
			"nonce": "1",
			"storage": {}
		},
		"0x37a9679c41e99db270bda88de8ff50c0cd23f326": {
			"balance": "0x0",
			"code": "0x",
			"nonce": "1",
			"storage": {}
		},
		"0x43064693d3d38ad6a7cb579e0d6d9718c8aa6b62": {
		  "balance": "0x0",
		  "code": "0x606060405236156100e55760e060020a600035046306fdde0381146100e757806318160ddd14610144578063313ce5671461014d57806345f0914014610159578063492f12af1461017d5780634958abb7146101905780635a3b7e42146101b157806370a082311461020e5780638da5cb5b1461022657806395d89b411461023857806397a5d5b5146102945780639d7e2730146102ac578063a9059cbb146102d0578063e343fea61461030a578063f2fde38b1461031b578063fa6f1c7d1461033c578063fde9ffd71461034e578063ff2ea5051461036f578063ffa3e90314610390575b005b6103b460058054602060026001831615610100026000190190921691909104601f810182900490910260809081016040526060828152929190828280156104635780601f1061043857610100808354040283529160200191610463565b61042260035481565b61042260075460ff1681565b6100e560043560243560005433600160a060020a039081169116146104c757610002565b61042c6007546301000000900460ff1681565b6100e560043560005433600160a060020a039081169116146104ee57610002565b6103b460048054602060026001831615610100026000190190921691909104601f810182900490910260809081016040526060828152929190828280156104635780601f1061043857610100808354040283529160200191610463565b61042260043560016020526000908152604090205481565b610422600054600160a060020a031681565b6103b4600680546020601f600260001960018516156101000201909316929092049182018190040260809081016040526060828152929190828280156104635780601f1061043857610100808354040283529160200191610463565b61042260043560026020526000908152604090205481565b6100e560043560243560005433600160a060020a0390811691161461050457610002565b6100e56004356024356000811080610300575033600160a060020a03166000908152600160205260409020548190105b1561055f57610002565b61042c600754610100900460ff1681565b6100e560043560005433600160a060020a039081169116146106c457610002565b61042c60075462010000900460ff1681565b6100e560043560005433600160a060020a039081169116146106e657610002565b6100e560043560005433600160a060020a039081169116146106fe57610002565b6100e560043560243560005433600160a060020a0390811691161461071857610002565b60405180806020018281038252838181518152602001915080519060200190808383829060006004602084601f0104600f02600301f150905090810190601f1680156104145780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b6060908152602090f35b15156060908152602090f35b820191906000526020600020905b81548152906001019060200180831161044657829003601f168201915b505050505081565b6040600090812080548490039055600380548490039055805460001984026060908152600160a060020a039190911691907f8b0c34a52f9e28d78caaa7066cd047b398dae74941a208b77777420f492bd7e190602090a35b5050565b600160a060020a038116600090815260016020526040812054839003101561046b57610002565b60078054610100830261ff001990911617905550565b600160a060020a03808216600090815260016020908152604082208054860190556003805486019055815460608681529316927f8b0c34a52f9e28d78caaa7066cd047b398dae74941a208b77777420f492bd7e19190a35050565b6007546301000000900460ff1680156105ae575033600160a060020a031660009081526002602081905260409091205414806105ae5750600160a060020a038216600090815260409020546002145b156105b857610002565b600760029054906101000a900460ff168015610624575060016002600050600033600160a060020a0316815260200190815260200160002060005054141580610624575060016002600050600084600160a060020a031681526020019081526020016000206000505414155b1561062e57610002565b600160a060020a033381166000818152600160209081526040808320805487900390559386168083529390912080548501905560608481527f8b0c34a52f9e28d78caaa7066cd047b398dae74941a208b77777420f492bd7e19190a3600754610100900460ff1680156106ba575033600160a060020a031660003a606082818181858883f19350505050155b156104c357610002565b6000805473ffffffffffffffffffffffffffffffffffffffff19168217905550565b6007805462010000830262ff00001990911617905550565b600780546301000000830263ff0000001990911617905550565b600160a060020a0390911660009081526002602052604090205556",
		  "nonce": "1",
		  "storage": {}
		},
		"0xd71a8fedb12971edbbc4336f174b031729651823": {
		  "balance": "0xea8c39a876d19888d",
		  "code": "0x",
		  "nonce": "1",
		  "storage": {}
		}
	  },
	  "config": {
		"byzantiumBlock": 1700000,
		"chainId": 3,
		"daoForkSupport": true,
		"eip150Block": 0,
		"eip150Hash": "0x41941023680923e0fe4d74a34bdac8141f2540e3ae90623718e47d66d1ca4a2d",
		"eip155Block": 10,
		"eip158Block": 10,
		"ethash": {},
		"homesteadBlock": 0
	  },
	  "difficulty": "3699098917",
	  "extraData": "0x4554482e45544846414e532e4f52472d4641313738394444",
	  "gasLimit": "5263953",
	  "hash": "0x03a0f62a8106793dafcfae7b75fd2654322062d585a19cea568314d7205790dc",
	  "miner": "0xbbf5029fd710d227630c8b7d338051b8e76d50b3",
	  "mixHash": "0x15482cc64b7c00a947f5bf015dfc010db1a6a668c74df61974d6a7848c174408",
	  "nonce": "0xd1bdb150f6fd170e",
	  "number": "2294630",
	  "stateRoot": "0x1ab1a534e84cc787cda1db21e0d5920ab06017948075b759166cfea7274657a1",
	  "timestamp": "1513675347",
	  "totalDifficulty": "7160543502214733"
	},
	"input": "0xf8aa018504a817c80083019a289437a9679c41e99db270bda88de8ff50c0cd23f32601b844a9059cbb0000000000000000000000009af0fe1ff4b1be80a300dd6756c83609ee7e0ac800000000000000000000000000000000000000000000000000b1a2bc2ec500001ca03f04db6e775f3d5e58b81397c9e7f26e42912de973d2a3869d7c9d82ac2c937ea05d13f0957cf9f8aa302787123b3539c7964aabcf3910cf8ffc7f5bcd91a33135",
	"result": {
	  "error": "out of gas",
	  "from": "0x94194bc2aaf494501d7880b61274a169f6502a54",
	  "gas": "0x7045",
	  "gasUsed": "0x7045",
	  "input": "0xa9059cbb000000000000000000000000e77b1ac803616503510bed0086e3a7be2627a69900000000000000000000000000000000000000000000000000000009502f9000",
	  "to": "0x43064693d3d38ad6a7cb579e0d6d9718c8aa6b62",
	  "type": "CALL",
	  "value": "0x0"
	}
  }	
`
var code = `0x606060405236156100825760e060020a600035046302d05d3f811461008a5780630accce061461009c5780631ab9075a146100c757806331ed274614610102578063645a3b7214610133578063772fdae314610155578063a7f4377914610180578063ae5f80801461019e578063c9bded21146101ea578063f905c15a14610231575b61023a610002565b61023c600054600160a060020a031681565b61023a600435602435604435606435608435600254600160a060020a03166000141561024657610002565b61023a600435600254600160a060020a03166000148015906100f8575060025433600160a060020a03908116911614155b156102f457610002565b61023a60043560243560443560643560843560a43560c435600254600160a060020a03166000141561031657610002565b61023a600435602435600254600160a060020a0316600014156103d057610002565b61023a600435602435604435606435608435600254600160a060020a03166000141561046157610002565b61023a60025433600160a060020a0390811691161461051657610002565b61023a6004356024356044356060828152600160a060020a0382169060ff8516907fa6c2f0913db6f79ff0a4365762c61718973b3413d6e40382e704782a9a5099f690602090a3505050565b61023a600435602435600160a060020a038116606090815260ff8316907fee6348a7ec70f74e3d6cba55a53e9f9110d180d7698e9117fc466ae29a43e34790602090a25050565b61023c60035481565b005b6060908152602090f35b60025460e060020a6313bc6d4b02606090815233600160a060020a0390811660645291909116906313bc6d4b906084906020906024816000876161da5a03f115610002575050604051511515905061029d57610002565b60408051858152602081018390528151600160a060020a03858116939087169260ff8a16927f5a690ecd0cb15c1c1fd6b6f8a32df0d4f56cb41a54fea7e94020f013595de796929181900390910190a45050505050565b6002805473ffffffffffffffffffffffffffffffffffffffff19168217905550565b60025460e060020a6313bc6d4b02606090815233600160a060020a0390811660645291909116906313bc6d4b906084906020906024816000876161da5a03f115610002575050604051511515905061036d57610002565b6040805186815260208101869052808201859052606081018490529051600160a060020a03831691889160ff8b16917fd65d9ddafbad8824e2bbd6f56cc9f4ac27ba60737035c10a321ea2f681c94d47919081900360800190a450505050505050565b60025460e060020a6313bc6d4b02606090815233600160a060020a0390811660645291909116906313bc6d4b906084906020906024816000876161da5a03f115610002575050604051511515905061042757610002565b60408051828152905183917fa9c6cbc4bd352a6940479f6d802a1001550581858b310d7f68f7bea51218cda6919081900360200190a25050565b60025460e060020a6313bc6d4b02606090815233600160a060020a0390811660645291909116906313bc6d4b906084906020906024816000876161da5a03f11561000257505060405151151590506104b857610002565b80600160a060020a031684600160a060020a03168660ff167f69bdaf789251e1d3a0151259c0c715315496a7404bce9fd0b714674685c2cab78686604051808381526020018281526020019250505060405180910390a45050505050565b600254600160a060020a0316ff`

func Test_Service(t *testing.T) {

	gtest.C(t, func(t *gtest.T) {
		s := callserver.NewService()
		e := &Trace{}
		s.Registration(e)
		msg := message.JsonMessage{}
		json.Unmarshal([]byte(`{
			"jsonrpc":"2.0",
			"method":"service_call",
			"params":[
				{
					"context": {
					  "difficulty": "3699098917",
					  "gasLimit": "5258985",
					  "miner": "0xd049bfd667cb46aa3ef5df0da3e57db3be39e511",
					  "number": "2294631",
					  "timestamp": "1513675366"
					},
					"genesis": {
					  "alloc": {
				
						"0xC20581085D9a543a81Fa9A70Dc5c8A78f6e29A3f": {
							"balance": "0xea8c39a876d19888d",
							"code": "0x",
							"nonce": "1",
							"storage": {}
						},
						"0x37a9679c41e99db270bda88de8ff50c0cd23f326": {
							"balance": "0x0",
							"code": "0x",
							"nonce": "1",
							"storage": {}
						},
						"0x43064693d3d38ad6a7cb579e0d6d9718c8aa6b62": {
						  "balance": "0x0",
						  "code": "0x606060405236156100e55760e060020a600035046306fdde0381146100e757806318160ddd14610144578063313ce5671461014d57806345f0914014610159578063492f12af1461017d5780634958abb7146101905780635a3b7e42146101b157806370a082311461020e5780638da5cb5b1461022657806395d89b411461023857806397a5d5b5146102945780639d7e2730146102ac578063a9059cbb146102d0578063e343fea61461030a578063f2fde38b1461031b578063fa6f1c7d1461033c578063fde9ffd71461034e578063ff2ea5051461036f578063ffa3e90314610390575b005b6103b460058054602060026001831615610100026000190190921691909104601f810182900490910260809081016040526060828152929190828280156104635780601f1061043857610100808354040283529160200191610463565b61042260035481565b61042260075460ff1681565b6100e560043560243560005433600160a060020a039081169116146104c757610002565b61042c6007546301000000900460ff1681565b6100e560043560005433600160a060020a039081169116146104ee57610002565b6103b460048054602060026001831615610100026000190190921691909104601f810182900490910260809081016040526060828152929190828280156104635780601f1061043857610100808354040283529160200191610463565b61042260043560016020526000908152604090205481565b610422600054600160a060020a031681565b6103b4600680546020601f600260001960018516156101000201909316929092049182018190040260809081016040526060828152929190828280156104635780601f1061043857610100808354040283529160200191610463565b61042260043560026020526000908152604090205481565b6100e560043560243560005433600160a060020a0390811691161461050457610002565b6100e56004356024356000811080610300575033600160a060020a03166000908152600160205260409020548190105b1561055f57610002565b61042c600754610100900460ff1681565b6100e560043560005433600160a060020a039081169116146106c457610002565b61042c60075462010000900460ff1681565b6100e560043560005433600160a060020a039081169116146106e657610002565b6100e560043560005433600160a060020a039081169116146106fe57610002565b6100e560043560243560005433600160a060020a0390811691161461071857610002565b60405180806020018281038252838181518152602001915080519060200190808383829060006004602084601f0104600f02600301f150905090810190601f1680156104145780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b6060908152602090f35b15156060908152602090f35b820191906000526020600020905b81548152906001019060200180831161044657829003601f168201915b505050505081565b6040600090812080548490039055600380548490039055805460001984026060908152600160a060020a039190911691907f8b0c34a52f9e28d78caaa7066cd047b398dae74941a208b77777420f492bd7e190602090a35b5050565b600160a060020a038116600090815260016020526040812054839003101561046b57610002565b60078054610100830261ff001990911617905550565b600160a060020a03808216600090815260016020908152604082208054860190556003805486019055815460608681529316927f8b0c34a52f9e28d78caaa7066cd047b398dae74941a208b77777420f492bd7e19190a35050565b6007546301000000900460ff1680156105ae575033600160a060020a031660009081526002602081905260409091205414806105ae5750600160a060020a038216600090815260409020546002145b156105b857610002565b600760029054906101000a900460ff168015610624575060016002600050600033600160a060020a0316815260200190815260200160002060005054141580610624575060016002600050600084600160a060020a031681526020019081526020016000206000505414155b1561062e57610002565b600160a060020a033381166000818152600160209081526040808320805487900390559386168083529390912080548501905560608481527f8b0c34a52f9e28d78caaa7066cd047b398dae74941a208b77777420f492bd7e19190a3600754610100900460ff1680156106ba575033600160a060020a031660003a606082818181858883f19350505050155b156104c357610002565b6000805473ffffffffffffffffffffffffffffffffffffffff19168217905550565b6007805462010000830262ff00001990911617905550565b600780546301000000830263ff0000001990911617905550565b600160a060020a0390911660009081526002602052604090205556",
						  "nonce": "1",
						  "storage": {}
						},
						"0xd71a8fedb12971edbbc4336f174b031729651823": {
						  "balance": "0xea8c39a876d19888d",
						  "code": "0x",
						  "nonce": "1",
						  "storage": {}
						}
					  },
					  "config": {
						"byzantiumBlock": 1700000,
						"chainId": 3,
						"daoForkSupport": true,
						"eip150Block": 0,
						"eip150Hash": "0x41941023680923e0fe4d74a34bdac8141f2540e3ae90623718e47d66d1ca4a2d",
						"eip155Block": 10,
						"eip158Block": 10,
						"ethash": {},
						"homesteadBlock": 0
					  },
					  "difficulty": "3699098917",
					  "extraData": "0x4554482e45544846414e532e4f52472d4641313738394444",
					  "gasLimit": "5263953",
					  "hash": "0x03a0f62a8106793dafcfae7b75fd2654322062d585a19cea568314d7205790dc",
					  "miner": "0xbbf5029fd710d227630c8b7d338051b8e76d50b3",
					  "mixHash": "0x15482cc64b7c00a947f5bf015dfc010db1a6a668c74df61974d6a7848c174408",
					  "nonce": "0xd1bdb150f6fd170e",
					  "number": "2294630",
					  "stateRoot": "0x1ab1a534e84cc787cda1db21e0d5920ab06017948075b759166cfea7274657a1",
					  "timestamp": "1513675347",
					  "totalDifficulty": "7160543502214733"
					},
					"input": "0xf8aa018504a817c80083019a289437a9679c41e99db270bda88de8ff50c0cd23f32601b844a9059cbb0000000000000000000000009af0fe1ff4b1be80a300dd6756c83609ee7e0ac800000000000000000000000000000000000000000000000000b1a2bc2ec500001ca03f04db6e775f3d5e58b81397c9e7f26e42912de973d2a3869d7c9d82ac2c937ea05d13f0957cf9f8aa302787123b3539c7964aabcf3910cf8ffc7f5bcd91a33135",
					"result": {
					  "error": "out of gas",
					  "from": "0x94194bc2aaf494501d7880b61274a169f6502a54",
					  "gas": "0x7045",
					  "gasUsed": "0x7045",
					  "input": "0xa9059cbb000000000000000000000000e77b1ac803616503510bed0086e3a7be2627a69900000000000000000000000000000000000000000000000000000009502f9000",
					  "to": "0x43064693d3d38ad6a7cb579e0d6d9718c8aa6b62",
					  "type": "CALL",
					  "value": "0x0"
					}
				  }	
			],
			"id":1
		}`), &msg)
		ctx := context.Background()
		rst := s.HandleMsg(ctx, &msg)
		t.AssertEQ(rst.Error, nil)

	})
}
